#!/bin/bash

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${YELLOW}[$(date +'%H:%M:%S')] $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Platforms to test
PLATFORMS=(
    "iOS Simulator,name=iPhone 16 Pro"
    "macOS"
    "tvOS Simulator,name=Apple TV 4K"
    "watchOS Simulator,name=Apple Watch Series 10"
)

SCHEME="DevTesting"
FAILED_PLATFORMS=()

print_status "Starting tests on all platforms..."
echo

for platform in "${PLATFORMS[@]}"; do
    platform_name=$(echo "$platform" | cut -d',' -f1)
    print_status "Testing on $platform_name..."

    if xcodebuild test -scheme "$SCHEME" -destination "platform=$platform"; then
        print_success "$platform_name tests passed"
    else
        print_error "$platform_name tests failed"
        FAILED_PLATFORMS+=("$platform_name")
    fi
    echo
done

# Summary
echo "=========================="
if [ ${#FAILED_PLATFORMS[@]} -eq 0 ]; then
    print_success "All platform tests passed!"
    exit 0
else
    print_error "Tests failed on: ${FAILED_PLATFORMS[*]}"
    exit 1
fi
